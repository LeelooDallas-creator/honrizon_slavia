---
export const prerender = false;

import AdminLayout from '@/layouts/admin/AdminLayout.astro';
import DeleteModal from '@/components/admin/DeleteModal.astro';
import Heading from '@/components/atoms/Heading/Heading.astro';
import Paragraph from '@/components/atoms/Paragraph/Paragraph.astro';
import { getSession, getCsrfToken } from '@/lib/auth';

const session = getSession(Astro.cookies);
if (!session) {
  return Astro.redirect('/admin/login');
}

const csrfToken = getCsrfToken(Astro.cookies);

const articlesResponse = await fetch(`${Astro.url.origin}/api/articles`, {
  headers: {
    'Cookie': Astro.request.headers.get('cookie') || '',
  }
});
const articlesData = await articlesResponse.json();

const title = 'Administration - Horizon Slavia';
---

<AdminLayout title={title}>
  <div class="page-header">
    <Heading level={1}>Administration</Heading>
    <a href="/admin/articles/new" class="btn-admin btn-new">+ Nouvel article</a>
  </div>

  <div class="admin-container">
    {articlesData.length === 0 ? (
      <div class="empty-state">
        <Heading level={2}>Aucun article pour le moment</Heading>
        <Paragraph>Commencez par créer votre premier article</Paragraph>
        <a href="/admin/articles/new" class="btn-admin btn-new">+ Créer un article</a>
      </div>
    ) : (
      <ul class="articles-list">
        {articlesData.map(({ article, country }: any) => (
          <li class="article-item">
            <div class="article-info">
              <Heading level={3} class="article-title">{article.title}</Heading>
              <div class="article-meta">
                <span class={`badge badge-${article.type}`}>{article.type}</span>
                <span>{country ? country.name : '—'}</span>
                <span class={`badge badge-${article.status}`}>
                  {article.status === 'published' ? 'Publié' : 'Brouillon'}
                </span>
                <span>Modifié le {new Date(article.updatedAt).toLocaleDateString('fr-FR')}</span>
              </div>
            </div>
            <div class="article-actions">
              <a href={`/admin/articles/${article.id}/edit`} class="btn-action">Modifier</a>
              <button
                type="button"
                class="btn-action delete"
                data-article-id={article.id}
                data-article-title={article.title}
              >
                Supprimer
              </button>
            </div>
          </li>
        ))}
      </ul>
    )}
  </div>

  <DeleteModal />

  <input type="hidden" id="csrf-token" value={csrfToken} />

  <script>
    // Handle article deletion - open modal
    document.querySelectorAll('.btn-action.delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.target as HTMLButtonElement;
        const articleId = target.dataset.articleId;
        const articleTitle = target.dataset.articleTitle;

        if (articleId && articleTitle) {
          (window as any).deleteModal.open(articleId, articleTitle);
        }
      });
    });
  </script>
</AdminLayout>

<style lang="scss">
  @use '@styles/admin/admin-components';
</style>

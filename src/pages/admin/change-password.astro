---
export const prerender = false;

import AdminLayout from '@/layouts/admin/AdminLayout.astro';
import Heading from '@/components/atoms/Heading/Heading.astro';
import { getSession, getCsrfToken } from '@/lib/auth';

const session = getSession(Astro.cookies);
if (!session) {
  return Astro.redirect('/admin/login');
}

const csrfToken = getCsrfToken(Astro.cookies);

const title = 'Changer mon mot de passe - Admin Horizon Slavia';
---

<AdminLayout title={title}>
  <div class="change-password-container">
    <div class="page-header">
      <Heading level={1}>Changer mon mot de passe</Heading>
    </div>

    <div class="form-card">
      <div id="successMessage" class="alert alert-success"></div>
      <div id="errorMessage" class="alert alert-error"></div>

      <form id="changePasswordForm">
        <input type="hidden" name="csrf_token" value={csrfToken} />

        <div class="form-group">
          <label for="currentPassword">Mot de passe actuel <span class="required">*</span></label>
          <input
            type="password"
            id="currentPassword"
            name="currentPassword"
            placeholder="Votre mot de passe actuel"
            required
            autocomplete="current-password"
          >
          <div id="currentPasswordError" class="field-error"></div>
        </div>

        <div class="form-group">
          <label for="newPassword">Nouveau mot de passe <span class="required">*</span></label>
          <input
            type="password"
            id="newPassword"
            name="newPassword"
            placeholder="Nouveau mot de passe"
            required
            autocomplete="new-password"
          >
          <div class="password-requirements">
            Minimum 8 caractères, avec au moins une majuscule, une minuscule et un chiffre
          </div>
          <div id="newPasswordError" class="field-error"></div>
        </div>

        <div class="form-group">
          <label for="confirmNewPassword">Confirmer le nouveau mot de passe <span class="required">*</span></label>
          <input
            type="password"
            id="confirmNewPassword"
            name="confirmNewPassword"
            placeholder="Confirmer le nouveau mot de passe"
            required
            autocomplete="new-password"
          >
          <div id="confirmNewPasswordError" class="field-error"></div>
        </div>

        <div class="form-actions">
          <button type="submit" id="submitBtn" class="btn-submit">
            Modifier mon mot de passe
          </button>
          <a href="/admin" class="btn-cancel">Annuler</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    const form = document.getElementById('changePasswordForm') as HTMLFormElement;
    const errorMessage = document.getElementById('errorMessage') as HTMLDivElement;
    const successMessage = document.getElementById('successMessage') as HTMLDivElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

    // Clear field errors
    function clearFieldError(fieldName: string) {
      const input = document.getElementById(fieldName) as HTMLInputElement;
      const error = document.getElementById(`${fieldName}Error`) as HTMLDivElement;
      input?.classList.remove('error');
      error?.classList.remove('show');
      error.textContent = '';
    }

    // Show field error
    function showFieldError(fieldName: string, message: string) {
      const input = document.getElementById(fieldName) as HTMLInputElement;
      const error = document.getElementById(`${fieldName}Error`) as HTMLDivElement;
      input?.classList.add('error');
      error?.classList.add('show');
      error.textContent = message;
    }

    // Clear all errors
    function clearAllErrors() {
      ['currentPassword', 'newPassword', 'confirmNewPassword'].forEach(clearFieldError);
      errorMessage.classList.remove('show');
      errorMessage.textContent = '';
      successMessage.classList.remove('show');
      successMessage.textContent = '';
    }

    // Add input listeners to clear errors on change
    ['currentPassword', 'newPassword', 'confirmNewPassword'].forEach(fieldName => {
      const input = document.getElementById(fieldName);
      input?.addEventListener('input', () => clearFieldError(fieldName));
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      clearAllErrors();

      submitBtn.disabled = true;
      submitBtn.textContent = 'Modification en cours...';

      try {
        const formData = new FormData(form);
        const currentPassword = formData.get('currentPassword') as string;
        const newPassword = formData.get('newPassword') as string;
        const confirmNewPassword = formData.get('confirmNewPassword') as string;
        const csrfToken = formData.get('csrf_token') as string;

        const response = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            currentPassword,
            newPassword,
            confirmNewPassword,
            csrfToken
          }),
        });

        const data = await response.json();

        if (response.ok) {
          // Password changed successfully
          successMessage.textContent = 'Mot de passe modifié avec succès !';
          successMessage.classList.add('show');

          // Clear form
          form.reset();

          // Redirect to admin after 2 seconds
          setTimeout(() => {
            window.location.href = '/admin';
          }, 2000);
        } else {
          // Handle validation errors
          if (data.details && Array.isArray(data.details)) {
            data.details.forEach((error: any) => {
              const fieldName = error.path[0];
              showFieldError(fieldName, error.message);
            });
          } else {
            errorMessage.textContent = data.error || 'Erreur lors de la modification du mot de passe';
            errorMessage.classList.add('show');
          }
        }
      } catch (error) {
        errorMessage.textContent = 'Erreur de connexion au serveur';
        errorMessage.classList.add('show');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Modifier mon mot de passe';
      }
    });
  </script>
</AdminLayout>

<style lang="scss">
  @use '@styles/abstracts/variables' as *;

  .change-password-container {
    max-width: 600px;
    margin: 0 auto;
  }

  .page-header {
    margin-bottom: $spacing-8;
  }

  .form-card {
    background: white;
    border-radius: $radius-lg;
    padding: $spacing-8;
    box-shadow: $shadow-sm;
  }

  .alert {
    padding: $spacing-4;
    border-radius: $radius-md;
    margin-bottom: $spacing-6;
    font-size: $font-size-sm;
    display: none;
  }

  .alert.show {
    display: block;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .form-group {
    margin-bottom: $spacing-6;
  }

  label {
    display: block;
    color: $color-gray-900;
    font-weight: $font-weight-medium;
    margin-bottom: $spacing-2;
    font-size: $font-size-sm;
  }

  .required {
    color: $color-error;
  }

  input[type="password"] {
    width: 100%;
    padding: $spacing-3 $spacing-4;
    border: 2px solid $color-gray-200;
    border-radius: $radius-md;
    font-size: $font-size-base;
    transition: all $transition-base;

    &:focus {
      outline: none;
      border-color: $color-primary;
      box-shadow: 0 0 0 3px rgba($color-primary, 0.1);
    }

    &.error {
      border-color: $color-error;
    }
  }

  .password-requirements {
    font-size: $font-size-xs;
    color: $color-gray-600;
    margin-top: $spacing-2;
    line-height: 1.5;
  }

  .field-error {
    color: $color-error;
    font-size: $font-size-xs;
    margin-top: $spacing-1;
    display: none;
  }

  .field-error.show {
    display: block;
  }

  .form-actions {
    display: flex;
    gap: $spacing-4;
    margin-top: $spacing-8;
  }

  .btn-submit {
    flex: 1;
    padding: $spacing-3 $spacing-6;
    background: $color-primary;
    color: white;
    border: none;
    border-radius: $radius-md;
    font-size: $font-size-base;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: all $transition-base;

    &:hover:not(:disabled) {
      background: darken($color-primary, 10%);
      transform: translateY(-1px);
      box-shadow: $shadow-md;
    }

    &:disabled {
      background: $color-gray-200;
      cursor: not-allowed;
      transform: none;
    }
  }

  .btn-cancel {
    padding: $spacing-3 $spacing-6;
    background: white;
    color: $color-gray-600;
    border: 2px solid $color-gray-200;
    border-radius: $radius-md;
    font-size: $font-size-base;
    font-weight: $font-weight-medium;
    text-decoration: none;
    cursor: pointer;
    transition: all $transition-base;
    display: inline-flex;
    align-items: center;

    &:hover {
      border-color: $color-gray-600;
      color: $color-gray-900;
    }
  }

  @media (max-width: 768px) {
    .form-card {
      padding: $spacing-6;
    }

    .form-actions {
      flex-direction: column;
    }

    .btn-cancel {
      text-align: center;
      justify-content: center;
    }
  }
</style>

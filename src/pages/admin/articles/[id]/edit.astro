---
export const prerender = false;

import AdminLayout from '@/layouts/admin/AdminLayout.astro';
import AdminFormArticle from '@/components/admin/AdminFormArticle.astro';
import Heading from '@/components/atoms/Heading/Heading.astro';
import Paragraph from '@/components/atoms/Paragraph/Paragraph.astro';
import { getSession, setCsrfToken, verifyCsrfToken } from '@/lib/auth';
import { z } from 'zod';

const session = getSession(Astro.cookies);
if (!session) {
  return Astro.redirect('/admin/login');
}

const { id} = Astro.params;

try {
  const uuidSchema = z.string().uuid();
  uuidSchema.parse(id);
} catch {
  return new Response('ID invalide', { status: 400 });
}

const csrfToken = setCsrfToken(Astro.cookies);

let errors: Record<string, string> = {};

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();

    const submittedCsrfToken = formData.get('csrf_token') as string;
    if (!verifyCsrfToken(Astro.cookies, submittedCsrfToken)) {
      errors.general = 'Token CSRF invalide. Veuillez réessayer.';
      throw new Error('CSRF validation failed');
    }

    const payload = {
      title: formData.get('title'),
      slug: formData.get('slug'),
      excerpt: formData.get('excerpt') || undefined,
      content: formData.get('content'),
      type: formData.get('type'),
      status: formData.get('status'),
      countryId: formData.get('countryId') || null,
      readingTime: formData.get('readingTime') ? parseInt(formData.get('readingTime') as string) : null,
      pdfUrl: formData.get('pdfUrl') || undefined,
    };

    const response = await fetch(`${Astro.url.origin}/api/articles/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Cookie': Astro.request.headers.get('cookie') || '',
        'X-CSRF-Token': csrfToken || '',
      },
      body: JSON.stringify(payload),
    });

    const data = await response.json();

    if (response.ok) {
      return Astro.redirect('/admin');
    } else {
      if (data.details) {
        // Zod validation errors
        data.details.forEach((err: any) => {
          errors[err.path[0]] = err.message;
        });
      } else {
        errors.general = data.error || 'Erreur lors de la modification';
      }
    }
  } catch {
    errors.general = 'Erreur de connexion au serveur';
  }
}

const [articleResponse, countriesResponse] = await Promise.all([
  fetch(`${Astro.url.origin}/api/articles/${id}`, {
    headers: {
      'Cookie': Astro.request.headers.get('cookie') || '',
    }
  }),
  fetch(`${Astro.url.origin}/api/articles`, {
    headers: {
      'Cookie': Astro.request.headers.get('cookie') || '',
    }
  })
]);

let article = null;
let notFound = false;

if (articleResponse.ok) {
  article = await articleResponse.json();
} else {
  notFound = true;
}

const articlesData = await countriesResponse.json();
const countries = Array.from(
  new Map(
    articlesData
      .filter((item: any) => item.country)
      .map((item: any) => [item.country.id, item.country])
  ).values()
) as Array<{ id: string; name: string }>;

const title = notFound ? 'Article non trouvé - Admin' : `Modifier "${article.title}" - Admin`;
---

<AdminLayout title={title}>
  {notFound ? (
    <div class="page-header">
      <Heading level={1}>Article non trouvé</Heading>
      <Paragraph>L'article demandé n'existe pas ou a été supprimé.</Paragraph>
      <a href="/admin" class="btn-admin btn-secondary">← Retour à la liste</a>
    </div>
  ) : (
    <>
      <div class="page-header">
        <Heading level={1}>Modifier l'article</Heading>
        <a href="/admin" class="btn-admin btn-secondary">← Retour à la liste</a>
      </div>

      <AdminFormArticle
        mode="edit"
        article={article}
        countries={countries}
        errors={errors}
        csrfToken={csrfToken}
      />
    </>
  )}
</AdminLayout>

<style lang="scss">
  @use '@styles/admin/admin-components';
</style>

---
export const prerender = false;

import AdminLayout from '@/layouts/admin/AdminLayout.astro';
import AdminFormArticle from '@/components/admin/AdminFormArticle.astro';
import Heading from '@/components/atoms/Heading/Heading.astro';
import { getSession, setCsrfToken, verifyCsrfToken } from '@/lib/auth';

const session = getSession(Astro.cookies);
if (!session) {
  return Astro.redirect('/admin/login');
}

const countriesResponse = await fetch(`${Astro.url.origin}/api/articles`, {
  headers: {
    'Cookie': Astro.request.headers.get('cookie') || '',
  }
});
const articlesData = await countriesResponse.json();
const countries = Array.from(
  new Map(
    articlesData
      .filter((item: any) => item.country)
      .map((item: any) => [item.country.id, item.country])
  ).values()
) as Array<{ id: string; name: string }>;

const title = 'Nouvel article - Admin';

const csrfToken = setCsrfToken(Astro.cookies);

let errors: Record<string, string> = {};

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();

    const submittedCsrfToken = formData.get('csrf_token') as string;
    if (!verifyCsrfToken(Astro.cookies, submittedCsrfToken)) {
      errors.general = 'Token CSRF invalide. Veuillez réessayer.';
      throw new Error('CSRF validation failed');
    }

    const payload = {
      title: formData.get('title'),
      slug: formData.get('slug'),
      excerpt: formData.get('excerpt') || undefined,
      content: formData.get('content'),
      type: formData.get('type'),
      status: formData.get('status'),
      countryId: formData.get('countryId') || null,
      readingTime: formData.get('readingTime') ? parseInt(formData.get('readingTime') as string) : null,
      pdfUrl: formData.get('pdfUrl') || undefined,
    };

    const response = await fetch(`${Astro.url.origin}/api/articles`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Cookie': Astro.request.headers.get('cookie') || '',
        'X-CSRF-Token': csrfToken || '',
      },
      body: JSON.stringify(payload),
    });

    const data = await response.json();

    if (response.ok) {
      return Astro.redirect('/admin');
    } else {
      if (data.details) {
        // Zod validation errors
        data.details.forEach((err: any) => {
          errors[err.path[0]] = err.message;
        });
      } else {
        errors.general = data.error || 'Erreur lors de la création';
      }
    }
  } catch {
    errors.general = 'Erreur de connexion au serveur';
  }
}
---

<AdminLayout title={title}>
  <div class="page-header">
    <Heading level={1}>Nouvel article</Heading>
    <a href="/admin" class="btn-admin btn-secondary">← Retour à la liste</a>
  </div>

  <AdminFormArticle
    mode="create"
    countries={countries}
    errors={errors}
    csrfToken={csrfToken}
  />
</AdminLayout>

<style lang="scss">
  @use '@styles/admin/admin-components';
</style>

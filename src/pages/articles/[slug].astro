---
import { db } from '@/lib/db';
import { articles, countries, users } from '@/lib/db/schema';
import { eq, and } from 'drizzle-orm';
import BaseHead from '@/components/BaseHead.astro';
import Header from '@/components/organisms/Header/Header.astro';
import Footer from '@/components/organisms/Footer/Footer.astro';
import Heading from '@/components/atoms/Heading/Heading.astro';
import Paragraph from '@/components/atoms/Paragraph/Paragraph.astro';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Fetch article by slug
const [articleData] = await db
  .select({
    article: articles,
    country: countries,
    author: users,
  })
  .from(articles)
  .leftJoin(countries, eq(articles.countryId, countries.id))
  .leftJoin(users, eq(articles.authorId, users.id))
  .where(and(
    eq(articles.slug, slug),
    eq(articles.status, 'published')
  ));

if (!articleData) {
  return Astro.redirect('/404');
}

const { article, country, author } = articleData;

const title = article.title;
const description = article.excerpt || `Article sur ${article.title}`;

function markdownToHtml(markdown: string): string {
  if (!markdown) return '';

  let html = markdown;

  const tableRegex = /^\|(.+)\|\s*\n\|[\s\-:|]+\|\s*\n((?:\|.+\|\s*\n?)+)/gm;
  html = html.replace(tableRegex, (_match, headerRow, bodyRows) => {
    const headers = headerRow.split('|').map((h: string) => h.trim()).filter((h: string) => h);
    const rows = bodyRows.trim().split('\n').map((row: string) =>
      row.split('|').map((cell: string) => cell.trim()).filter((cell: string) => cell)
    );

    let table = '<table>\n<thead>\n<tr>\n';
    headers.forEach((header: string) => {
      table += `<th>${header}</th>\n`;
    });
    table += '</tr>\n</thead>\n<tbody>\n';

    rows.forEach((row: string[]) => {
      table += '<tr>\n';
      row.forEach((cell: string) => {
        table += `<td>${cell}</td>\n`;
      });
      table += '</tr>\n';
    });

    table += '</tbody>\n</table>\n';
    return table;
  });

  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');

  html = html.replace(/^######\s+(.*)$/gim, '<h6>$1</h6>');
  html = html.replace(/^#####\s+(.*)$/gim, '<h5>$1</h5>');
  html = html.replace(/^####\s+(.*)$/gim, '<h4>$1</h4>');
  html = html.replace(/^###\s+(.*)$/gim, '<h3>$1</h3>');
  html = html.replace(/^##\s+(.*)$/gim, '<h2>$1</h2>');
  html = html.replace(/^#\s+(.*)$/gim, '<h1>$1</h1>');

  html = html.replace(/^---+$/gim, '<hr>');

  html = html.replace(/^[\*\-\+]\s+(.*$)/gim, '<li>$1</li>');
  html = html.replace(/(<li>.*?<\/li>\s*)+/gs, (match) => `<ul>${match}</ul>`);
  html = html.replace(/^\d+\.\s+(.*$)/gim, '<li>$1</li>');

  const lines = html.split('\n');
  const result = [];
  let i = 0;

  while (i < lines.length) {
    const line = lines[i].trim();

    if (!line) {
      i++;
      continue;
    }

    if (line.startsWith('<h') || line.startsWith('<hr>')) {
      result.push(line);
      i++;
    } else if (line.startsWith('<table')) {
      const tableLines = [line];
      i++;
      while (i < lines.length && !lines[i].trim().startsWith('</table>')) {
        tableLines.push(lines[i].trim());
        i++;
      }
      if (i < lines.length) {
        tableLines.push(lines[i].trim());
        i++;
      }
      result.push(tableLines.join('\n'));
    } else if (line.startsWith('<ul')) {
      const listLines = [line];
      i++;
      while (i < lines.length && !lines[i].trim().startsWith('</ul>')) {
        listLines.push(lines[i].trim());
        i++;
      }
      if (i < lines.length) {
        listLines.push(lines[i].trim());
        i++;
      }
      result.push(listLines.join('\n'));
    } else if (line.startsWith('<ol')) {
      const listLines = [line];
      i++;
      while (i < lines.length && !lines[i].trim().startsWith('</ol>')) {
        listLines.push(lines[i].trim());
        i++;
      }
      if (i < lines.length) {
        listLines.push(lines[i].trim());
        i++;
      }
      result.push(listLines.join('\n'));
    } else {
      const paragraph = [];
      while (i < lines.length && lines[i].trim() &&
             !lines[i].trim().startsWith('<h') &&
             !lines[i].trim().startsWith('<table') &&
             !lines[i].trim().startsWith('<ul') &&
             !lines[i].trim().startsWith('<ol') &&
             !lines[i].trim().startsWith('<hr>')) {
        paragraph.push(lines[i].trim());
        i++;
      }
      if (paragraph.length > 0) {
        result.push(`<p>${paragraph.join(' ')}</p>`);
      }
    }
  }

  html = result.join('\n');

  return html;
}

const contentHtml = markdownToHtml(article.content);
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <BaseHead title={title} description={description} />
  </head>
  <body class="article-page">
    <Header transparent={false} />

    <main>
      <article class="article-container">
        <!-- Article Header -->
        <header class="article-header">
          <div class="article-meta">
            <span class="article-type">{article.type}</span>
            {country && <span class="article-country">{country.name}</span>}
            {article.readingTime && (
              <span class="article-reading-time">{article.readingTime} min de lecture</span>
            )}
          </div>

          <Heading level={1} class="article-title">{article.title}</Heading>

          {article.excerpt && (
            <Paragraph class="article-excerpt">{article.excerpt}</Paragraph>
          )}

          {article.coverImageUrl && (
            <div class="article-cover">
              <img src={article.coverImageUrl} alt={article.title} />
            </div>
          )}

          <div class="article-info">
            <time datetime={article.publishedAt?.toISOString()} class="article-date">
              Publié le {article.publishedAt?.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
            {author && (
              <span class="article-author">
                Par {author.firstName} {author.lastName}
              </span>
            )}
          </div>
        </header>

        <!-- Article Content -->
        <div class={article.type === 'ressource' ? 'mdx-content ressource-with-accordions' : 'mdx-content'} set:html={contentHtml} />

        <!-- Article Footer -->
        {article.pdfUrl && (
          <footer class="article-footer">
            <a href={article.pdfUrl} download class="article-pdf-download">
              Télécharger en PDF
            </a>
          </footer>
        )}
      </article>
    </main>

    <Footer />

    <script>
      import { initAutoAccordions } from '@/scripts/accordions';

      document.addEventListener('DOMContentLoaded', () => {
        initAutoAccordions();
      });
    </script>
  </body>
</html>

<style lang="scss">
  @use '@styles/abstracts/variables' as *;
  @use '@styles/pages/mdx' as *;

  .article-page {
    margin: 0;
    padding: 0;
  }

  main {
    padding-top: 5rem;
  }

  .article-container {
    max-width: 800px;
    margin: 0 auto;
    padding: $spacing-16 $spacing-6;
  }

  .article-header {
    margin-bottom: $spacing-12;
  }

  .article-meta {
    display: flex;
    gap: $spacing-3;
    margin-bottom: $spacing-4;
    flex-wrap: wrap;
  }

  .article-type,
  .article-country,
  .article-reading-time {
    padding: $spacing-1 $spacing-3;
    background: $color-gray-100;
    color: $color-primary;
    border-radius: $radius-full;
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
  }

  .article-type {
    background: $color-primary;
    color: $color-white;
    text-transform: capitalize;
  }

  .article-title {
    margin-bottom: $spacing-4;
    color: $color-primary;
  }

  .article-excerpt {
    font-size: $font-size-lg;
    color: $color-gray-700;
    font-style: italic;
    margin-bottom: $spacing-6;
  }

  .article-cover {
    width: 100%;
    margin-bottom: $spacing-6;
    border-radius: $radius-lg;
    overflow: hidden;

    img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }
  }

  .article-info {
    display: flex;
    gap: $spacing-4;
    padding: $spacing-4 0;
    border-top: 1px solid $color-gray-200;
    border-bottom: 1px solid $color-gray-200;
    margin-bottom: $spacing-8;
    font-size: $font-size-sm;
    color: $color-gray-600;
    flex-wrap: wrap;
  }

  .article-date,
  .article-author {
    display: flex;
    align-items: center;
  }

  .article-content {
    font-size: $font-size-base;
    line-height: $line-height-relaxed;
    color: $color-gray-900;

    :global(h1) {
      font-family: $font-heading;
      font-size: $font-size-3xl;
      color: $color-primary;
      margin-top: $spacing-12;
      margin-bottom: $spacing-4;
    }

    :global(h2) {
      font-family: $font-heading;
      font-size: $font-size-2xl;
      color: $color-primary;
      margin-top: $spacing-10;
      margin-bottom: $spacing-4;
    }

    :global(h3) {
      font-family: $font-heading;
      font-size: $font-size-xl;
      color: $color-primary;
      margin-top: $spacing-8;
      margin-bottom: $spacing-3;
    }

    :global(p) {
      margin-bottom: $spacing-4;
    }

    :global(a) {
      color: $color-secondary;
      text-decoration: underline;

      &:hover {
        color: darken($color-secondary, 10%);
      }
    }

    :global(ul),
    :global(ol) {
      margin-bottom: $spacing-4;
      padding-left: $spacing-6;
      list-style-position: outside;
    }

    :global(ul) {
      list-style-type: disc;
    }

    :global(ol) {
      list-style-type: decimal;
    }

    :global(li) {
      margin-bottom: $spacing-2;
    }

    :global(blockquote) {
      border-left: 4px solid $color-accent;
      padding-left: $spacing-4;
      margin: $spacing-6 0;
      font-style: italic;
      color: $color-gray-700;
    }

    :global(strong) {
      font-weight: $font-weight-bold;
      color: $color-gray-900;
    }

    :global(em) {
      font-style: italic;
    }
  }

  .article-footer {
    margin-top: $spacing-12;
    padding-top: $spacing-6;
    border-top: 1px solid $color-gray-200;
  }

  .article-pdf-download {
    display: inline-flex;
    align-items: center;
    gap: $spacing-2;
    padding: $spacing-3 $spacing-6;
    background: $color-primary;
    color: $color-white;
    text-decoration: none;
    border-radius: $radius-md;
    font-weight: $font-weight-medium;
    transition: all $transition-base;

    &:hover {
      background: darken($color-primary, 10%);
      transform: translateY(-2px);
      box-shadow: $shadow-md;
    }
  }

  @media (max-width: 768px) {
    main {
      padding-top: 4rem;
    }

    .article-container {
      padding: $spacing-10 $spacing-4;
    }

    .article-content {
      :global(h1) {
        font-size: $font-size-2xl;
      }

      :global(h2) {
        font-size: $font-size-xl;
      }

      :global(h3) {
        font-size: $font-size-lg;
      }
    }
  }
</style>

---
// ============================================
// HERO COMPONENT - Vidéo + Intersection
// ============================================
import type { HeroProps } from './Hero.types';

const {
  videoUrl = '/videos/timelapse-budapest.mp4',
  title = "Horizon Slavia",
  subtitle = "Découvrez l'Europe de l'Est autrement",
} = Astro.props as HeroProps;
---

<!-- Hero avec vidéo -->
<section class="hero-video">
  <div class="hero-video__background">
    <!-- Vidéo -->
    <video
      class="hero-video__video"
      src={videoUrl}
      loop
      muted
      playsinline
      preload="auto"
      aria-hidden="true"
    >
      <source src={videoUrl} type="video/mp4" />
      <!-- Fallback pour navigateurs sans support -->
      Votre navigateur ne supporte pas la vidéo HTML5.
    </video>
    
    <!-- Overlay pour assombrir la vidéo -->
    <div class="hero-video__overlay" aria-hidden="true"></div>
  </div>
  
  <!-- Contenu par-dessus la vidéo -->
  <div class="hero-video__content">
    <div class="hero-video__container">
      <h1 class="hero-video__title">{title}</h1>
      {subtitle && <p class="hero-video__subtitle">{subtitle}</p>}
    </div>
  </div>
  
  <!-- Indicateur de scroll -->
  <div class="hero-video__scroll-indicator" aria-hidden="true">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M12 5v14m0 0l-7-7m7 7l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
</section>

<style lang="scss">
  @use './Hero.styles.scss';
</style>

<script>
  // Gestion de la vidéo avec IntersectionObserver
  const video = document.querySelector('.hero-video__video') as HTMLVideoElement;

  if (video) {
    // Gestion des erreurs
    video.addEventListener('error', (e) => {
      console.error('Erreur de chargement vidéo:', e);
    });

    // Fonction pour démarrer la vidéo
    const playVideo = () => {
      if (video.readyState >= 2) {
        video.play().catch(() => {
          // L'autoplay sera débloqué par l'interaction utilisateur
        });
      }
    };

    // Observer pour détecter quand la vidéo est visible
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              playVideo();
            } else {
              video.pause();
            }
          });
        },
        {
          threshold: 0.25
        }
      );

      observer.observe(video);
    }

    // Attendre que la vidéo soit chargée avant d'essayer de la lire
    if (video.readyState >= 2) {
      playVideo();
    } else {
      video.addEventListener('loadeddata', playVideo, { once: true });
    }

    // Démarrer la vidéo au premier clic/scroll/touch (interaction utilisateur)
    const startOnInteraction = () => {
      playVideo();
      // Retirer les listeners après la première interaction
      document.removeEventListener('click', startOnInteraction);
      document.removeEventListener('scroll', startOnInteraction);
      document.removeEventListener('touchstart', startOnInteraction);
      document.removeEventListener('keydown', startOnInteraction);
    };

    document.addEventListener('click', startOnInteraction);
    document.addEventListener('scroll', startOnInteraction);
    document.addEventListener('touchstart', startOnInteraction);
    document.addEventListener('keydown', startOnInteraction);
  }

  // Animation du scroll indicator
  const scrollIndicator = document.querySelector('.hero-video__scroll-indicator');

  if (scrollIndicator) {
    window.addEventListener('scroll', () => {
      const scrolled = window.scrollY;
      const heroHeight = document.querySelector('.hero-video')?.clientHeight || 0;

      if (scrolled > heroHeight * 0.3) {
        scrollIndicator.classList.add('hidden');
      } else {
        scrollIndicator.classList.remove('hidden');
      }
    });
  }
</script>
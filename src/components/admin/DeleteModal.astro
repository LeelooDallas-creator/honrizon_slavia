---
// Delete modal component for article deletion

import Modal from '@components/molecules/Modal/Modal.astro';
import Button from '@components/atoms/Button/Button.astro';
import Paragraph from '@components/atoms/Paragraph/Paragraph.astro';
---

<Modal id="deleteModal" title="Supprimer l'article" size="md" titleLevel={3}>
  <div class="delete-modal">
    <Paragraph size="base" variant="gray">
      Vous êtes sur le point de supprimer l'article :
    </Paragraph>

    <p class="delete-modal__title" id="modalArticleTitle">—</p>

    <div class="delete-modal__alert">
      <strong>Attention :</strong> Cette action est irréversible. L'article sera définitivement supprimé.
    </div>

    <div class="delete-modal__confirmation">
      <label class="checkbox-label">
        <input type="checkbox" id="confirmCheckbox" />
        <Paragraph size="base">Je confirme vouloir supprimer cet article</Paragraph>
      </label>
    </div>

    <div id="modalError" class="delete-modal__message" style="display: none;"></div>
    <div id="modalSuccess" class="delete-modal__message delete-modal__message--success" style="display: none;">
      ✅ Article supprimé avec succès !
    </div>
  </div>

  <div slot="footer" class="delete-modal__actions">
    <Button
      text="Annuler"
      variant="secondary"
      type="button"
      dataAttributes={{ 'data-modal-close': '' }}
    />
    <button class="btn--danger" id="modalDeleteBtn" disabled>
      <span id="btnText">Supprimer définitivement</span>
      <span id="btnLoader" style="display: none;">⏳ Suppression...</span>
    </button>
  </div>
</Modal>

<style lang="scss">
  @use '@styles/abstracts/variables' as *;
  @use '@styles/admin/admin-components';
  @use 'sass:color';

  .delete-modal {
    &__title {
      font-size: $font-size-xl;
      font-weight: $font-weight-semibold;
      color: $color-primary;
      padding: $spacing-4;
      background: $color-neutral-light;
      border-radius: $radius-md;
      margin: $spacing-3 0 $spacing-5;
      word-break: break-word;
    }

    &__alert {
      background: color.scale($color-accent, $lightness: 80%);
      border: 1px solid $color-accent;
      border-radius: $radius-md;
      padding: $spacing-4;
      margin-bottom: $spacing-6;
      font-size: $font-size-sm;
      color: color.scale($color-accent, $lightness: -40%);
      line-height: 1.5;

      strong {
        display: block;
        margin-bottom: $spacing-1;
      }
    }

    &__confirmation {
      margin-bottom: $spacing-5;
    }

    &__message {
      padding: $spacing-3 $spacing-4;
      border-radius: $radius-md;
      font-size: $font-size-sm;
      margin-top: $spacing-4;
      background: color.scale($color-secondary, $lightness: 85%);
      color: $color-secondary;
      border: 1px solid color.scale($color-secondary, $lightness: 60%);

      &--success {
        background: color.scale($color-nature, $lightness: 85%);
        color: $color-nature;
        border: 1px solid color.scale($color-nature, $lightness: 65%);
      }
    }

    &__actions {
      display: flex;
      gap: $spacing-3;
      width: 100%;
    }
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: $spacing-3;
    cursor: pointer;
    user-select: none;

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: $color-secondary;
      flex-shrink: 0;
    }

    :global(p) {
      margin: 0;
    }
  }
</style>

<script>
  interface DeleteModalState {
    articleId: string | null;
    articleTitle: string | null;
    isLoading: boolean;
  }

  class DeleteModalController {
    private state: DeleteModalState = {
      articleId: null,
      articleTitle: null,
      isLoading: false,
    };

    private elements = {
      articleTitle: document.getElementById('modalArticleTitle') as HTMLParagraphElement,
      confirmCheckbox: document.getElementById('confirmCheckbox') as HTMLInputElement,
      deleteBtn: document.getElementById('modalDeleteBtn') as HTMLButtonElement,
      error: document.getElementById('modalError') as HTMLDivElement,
      success: document.getElementById('modalSuccess') as HTMLDivElement,
      btnText: document.getElementById('btnText') as HTMLSpanElement,
      btnLoader: document.getElementById('btnLoader') as HTMLSpanElement,
    };

    constructor() {
      this.init();
    }

    private init(): void {
      this.elements.confirmCheckbox.addEventListener('change', () => this.handleCheckboxChange());
      this.elements.deleteBtn.addEventListener('click', () => this.handleDelete());
    }

    public open(articleId: string, articleTitle: string): void {
      this.state.articleId = articleId;
      this.state.articleTitle = articleTitle;

      // Reset UI
      this.elements.articleTitle.textContent = articleTitle;
      this.elements.confirmCheckbox.checked = false;
      this.elements.deleteBtn.disabled = true;
      this.elements.error.style.display = 'none';
      this.elements.success.style.display = 'none';

      // Open modal using global utility
      (window as any).modalUtils.openModal('deleteModal');
    }

    private handleCheckboxChange(): void {
      this.elements.deleteBtn.disabled = !this.elements.confirmCheckbox.checked;
    }

    private async handleDelete(): Promise<void> {
      if (!this.state.articleId || this.state.isLoading) return;

      this.state.isLoading = true;
      this.setLoadingState(true);
      this.elements.error.style.display = 'none';
      this.elements.success.style.display = 'none';

      try {
        const csrfToken = (document.getElementById('csrf-token') as HTMLInputElement)?.value;

        if (!csrfToken) {
          this.showError('Token CSRF manquant');
          this.state.isLoading = false;
          this.setLoadingState(false);
          return;
        }

        const response = await fetch(`/api/articles/${this.state.articleId}`, {
          method: 'DELETE',
          headers: {
            'X-CSRF-Token': csrfToken,
          },
        });

        if (response.ok) {
          this.elements.success.style.display = 'block';
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          const data = await response.json();
          this.showError(data.error || 'Erreur lors de la suppression');
          this.state.isLoading = false;
          this.setLoadingState(false);
        }
      } catch (error) {
        this.showError('Erreur de connexion au serveur');
        this.state.isLoading = false;
        this.setLoadingState(false);
      }
    }

    private setLoadingState(loading: boolean): void {
      this.elements.deleteBtn.disabled = loading;
      this.elements.confirmCheckbox.disabled = loading;

      if (loading) {
        this.elements.btnText.style.display = 'none';
        this.elements.btnLoader.style.display = 'inline';
      } else {
        this.elements.btnText.style.display = 'inline';
        this.elements.btnLoader.style.display = 'none';
      }
    }

    private showError(message: string): void {
      this.elements.error.textContent = `❌ ${message}`;
      this.elements.error.style.display = 'block';
    }
  }

  const deleteModalController = new DeleteModalController();
  (window as any).deleteModal = deleteModalController;
</script>
